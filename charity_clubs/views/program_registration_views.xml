<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- List View -->
    <record id="view_program_registration_list" model="ir.ui.view">
        <field name="name">program.registration.list</field>
        <field name="model">program.registration</field>
        <field name="arch" type="xml">
            <list string="التسجيلات" decoration-success="state == 'confirmed'"
                  decoration-warning="state == 'waitlist'"
                  decoration-muted="state == 'cancelled'"
                  decoration-info="state == 'submitted'">
                <field name="registration_number"/>
                <field name="registration_date" widget="date"/>
                <field name="student_name"/>
                <field name="program_id"/>
                <field name="club_id"/>
                <field name="age" string="العمر"/>
                <field name="gender"/>
                <field name="parent_mobile" widget="phone"/>
                <field name="state" widget="badge"/>
                <field name="payment_state" widget="badge"
                       decoration-success="payment_state == 'paid'"
                       decoration-warning="payment_state == 'partial'"
                       decoration-danger="payment_state == 'not_paid'"/>
                <field name="total_amount" widget="monetary" sum="الإجمالي"/>
                <field name="paid_amount" widget="monetary" sum="المدفوع"/>
                <field name="company_id" invisible="1"/>
            </list>
        </field>
    </record>

    <!-- Form View -->
    <record id="view_program_registration_form" model="ir.ui.view">
        <field name="name">program.registration.form</field>
        <field name="model">program.registration</field>
        <field name="arch" type="xml">
            <form string="تسجيل في البرنامج">
                <header>
                    <button name="action_submit" type="object"
                            string="تقديم" class="btn-primary"
                            invisible="state != 'draft'"/>
                    <button name="action_confirm" type="object"
                            string="تأكيد التسجيل" class="btn-success"
                            invisible="state != 'submitted'"
                            groups="base.group_user"/>
                    <button name="action_cancel" type="object"
                            string="إلغاء"
                            invisible="state in ('cancelled', 'confirmed')"/>
                    <button name="action_reset_draft" type="object"
                            string="إعادة للمسودة"
                            invisible="state not in ('submitted', 'waitlist', 'cancelled')"
                            groups="base.group_user"/>
                    <field name="state" widget="statusbar"
                           statusbar_visible="draft,submitted,confirmed"/>
                </header>
                <sheet>
                    <div class="oe_button_box" name="button_box">
                        <button class="oe_stat_button" icon="fa-money"
                                invisible="payment_state == 'not_paid'">
                            <div class="o_field_widget o_stat_info">
                                <span class="o_stat_value">
                                    <field name="paid_amount" widget="monetary"/> / <field name="total_amount" widget="monetary"/>
                                </span>
                                <span class="o_stat_text">المدفوعات</span>
                            </div>
                        </button>
                        <button name="action_view_invoices" type="object"
                                class="oe_stat_button" icon="fa-file-text-o"
                                invisible="invoice_count == 0">
                            <field name="invoice_count" widget="statinfo" string="الفواتير"/>
                        </button>
                    </div>
                    <field name="invoice_count" invisible="1"/>
                    <widget name="web_ribbon" title="قائمة انتظار" bg_color="bg-warning"
                            invisible="state != 'waitlist'"/>
                    <widget name="web_ribbon" title="ملغي" bg_color="bg-danger"
                            invisible="state != 'cancelled'"/>
                    <div class="oe_title">
                        <h1>
                            <field name="registration_number" readonly="1"/>
                        </h1>
                        <h3>
                            <field name="program_id" options="{'no_create': True}"
                                   readonly="state != 'draft'"
                                   domain="[('state', '=', 'open'), ('active', '=', True)]"/>
                        </h3>
                    </div>

                    <group>
                        <group string="معلومات التسجيل">
                            <field name="club_id" readonly="1"/>
                            <field name="registration_date" readonly="1"/>
                            <field name="selected_terms" readonly="state != 'draft'"/>
                            <field name="currency_id" invisible="1"/>
                            <field name="total_amount" widget="monetary" readonly="1"/>
                        </group>
                        <group string="حالة الدفع">
                            <field name="partner_id" readonly="state != 'draft'"
                                   context="{'default_name': father_name, 'default_phone': parent_mobile, 'default_email': parent_email}"/>
                            <field name="paid_amount" widget="monetary" readonly="1"/>
                            <field name="remaining_amount" widget="monetary" readonly="1"/>
                            <field name="payment_state" readonly="1"/>
                        </group>
                    </group>

                    <notebook>
                        <page string="معلومات الطالب" name="student_info">
                            <group>
                                <group string="البيانات الشخصية">
                                    <field name="student_name" placeholder="كما في الهوية الإماراتية"
                                           readonly="state != 'draft'"/>
                                    <field name="birth_date" readonly="state != 'draft'"/>
                                    <field name="age" readonly="1"/>
                                    <field name="gender" readonly="state != 'draft'"/>

                                </group>
                                <group string="معلومات إضافية">
                                    <field name="nationality_id" options="{'no_create': True}"
                                           readonly="state != 'draft'"/>
                                    <field name="native_language" readonly="state != 'draft'"/>
                                    <field name="school_name" readonly="state != 'draft'"/>
                                    <field name="class_level" readonly="state != 'draft'"/>
                                </group>
                            </group>
                            <group string="الخبرات السابقة">
                                <group>
                                    <field name="attended_arabic_club" widget="radio_button"
                                           readonly="state != 'draft'"/>
                                    <field name="attended_summer_activities" widget="radio_button"
                                           readonly="state != 'draft'"/>
                                    <field name="interested_quran" widget="radio_button"
                                           readonly="state != 'draft'"/>
                                    <field name="quran_memorisation"
                                           readonly="state != 'draft'"/>
                                </group>
                            </group>
                        </page>

                        <page string="معلومات ولي الأمر" name="parent_info">
                            <group>
                                <group string="الأسماء">
                                    <field name="father_name" readonly="state != 'draft'"/>
                                    <field name="mother_name" readonly="state != 'draft'"/>
                                </group>
                                <group string="معلومات الاتصال">
                                    <field name="parent_mobile" widget="phone"
                                           placeholder="+971501234567"
                                           readonly="state != 'draft'"/>
                                    <field name="mother_whatsapp" widget="phone"
                                           placeholder="+971501234567"
                                           readonly="state != 'draft'"/>
                                    <field name="parent_email" widget="email"
                                           readonly="state != 'draft'"/>
                                </group>
                            </group>
                            <group string="العنوان">
                                <group>
                                    <field name="street" placeholder="الشارع..."
                                           readonly="state != 'draft'"/>
                                    <field name="city" placeholder="المدينة"
                                           readonly="state != 'draft'"/>
                                    <field name="state_id" options="{'no_create': True}"
                                           readonly="state != 'draft'"/>
                                </group>
                            </group>
                        </page>

                        <page string="المستندات والموافقات" name="documents">
                            <group>
                                <group string="المستندات المطلوبة">
                                    <field name="emirates_id_copy" filename="emirates_id_filename"
                                           widget="binary"
                                           readonly="state != 'draft'"/>
                                    <field name="emirates_id_filename" invisible="1"/>
                                    <field name="student_photo" filename="student_photo_filename"
                                           widget="image" options="{'size': [200, 200]}"
                                           readonly="state != 'draft'"/>
                                    <field name="student_photo_filename" invisible="1"/>
                                </group>
                                <group string="الموافقات">

                                    <field name="photo_permission"
                                           readonly="state != 'draft'"/>
                                </group>
                            </group>
                            <div class="alert alert-info" role="alert">
                                <i class="fa fa-info-circle"/>
                                ملاحظة: يُحتفظ بصور الطلاب في قاعدة البيانات لأغراض الصحة والسلامة.
                                يرجى إرسال الصور عبر البريد الإلكتروني إذا كانت لديك مخاوف أمنية.
                            </div>
                        </page>

                        <page string="معلومات طبية" name="medical">
                            <group>
                                <field name="medical_conditions" placeholder="أي حالات طبية خاصة..."
                                       readonly="state != 'draft'"/>
                                <field name="allergies" placeholder="أي حساسية من الطعام أو الأدوية..."
                                       readonly="state != 'draft'"/>
                            </group>
                        </page>

                        <page string="ملاحظات" name="notes">
                            <field name="notes" placeholder="أي ملاحظات إضافية..."
                                   readonly="state != 'draft'"/>
                            <field name="rejection_reason"
                                   invisible="state != 'cancelled'"
                                   readonly="1"
                                   placeholder="سبب الرفض..."/>
                        </page>
                    </notebook>
                </sheet>
                <chatter/>
            </form>
        </field>
    </record>

    <!-- Kanban View -->
    <record id="view_program_registration_kanban" model="ir.ui.view">
        <field name="name">program.registration.kanban</field>
        <field name="model">program.registration</field>
        <field name="arch" type="xml">
            <kanban default_group_by="program_id" sample="1">
                <field name="id"/>
                <field name="registration_number"/>
                <field name="student_name"/>
                <field name="program_id"/>
                <field name="club_id"/>
                <field name="age"/>
                <field name="gender"/>
                <field name="state"/>
                <field name="payment_state"/>
                <field name="total_amount"/>
                <field name="currency_id"/>
                <field name="student_photo"/>
                <progressbar field="state"
                             colors='{"confirmed": "success", "submitted": "info", "waitlist": "warning", "cancelled": "danger"}'/>
                <templates>
                    <t t-name="kanban-box">
                        <div class="oe_kanban_global_click o_kanban_record_has_image_fill">
                            <div class="o_kanban_image_fill_left d-none d-md-block"
                                 t-attf-style="background-image: url(#{kanban_image('program.registration', 'student_photo', record.id.raw_value)})"
                                 role="img"/>
                            <div class="oe_kanban_content">
                                <div class="o_kanban_record_top">
                                    <div class="o_kanban_record_headings">
                                        <strong class="o_kanban_record_title">
                                            <field name="student_name"/>
                                        </strong>
                                        <br/>
                                        <small class="text-muted">
                                            <field name="registration_number"/>
                                        </small>
                                    </div>
                                    <field name="state" widget="label_selection"
                                           options="{'classes': {'confirmed': 'success', 'submitted': 'info', 'waitlist': 'warning', 'cancelled': 'danger'}}"/>
                                </div>

                                <div class="o_kanban_record_body mt-2">
                                    <div>
                                        <i class="fa fa-graduation-cap me-1"/>
                                        <field name="program_id"/>
                                    </div>
                                    <div>
                                        <i class="fa fa-child me-1"/>
                                        <span>
                                            <t t-esc="Math.floor(record.age.raw_value)"/> سنة -
                                            <field name="gender"/>
                                        </span>
                                    </div>
                                </div>

                                <div class="o_kanban_record_bottom mt-2">
                                    <div class="oe_kanban_bottom_left">
                                        <field name="payment_state" widget="label_selection"
                                               options="{'classes': {'paid': 'success', 'partial': 'warning', 'not_paid': 'danger'}}"/>
                                    </div>
                                    <div class="oe_kanban_bottom_right">
                                        <field name="total_amount" widget="monetary"/>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <!-- Search View -->
    <record id="view_program_registration_search" model="ir.ui.view">
        <field name="name">program.registration.search</field>
        <field name="model">program.registration</field>
        <field name="arch" type="xml">
            <search string="البحث في التسجيلات">
                <field name="registration_number"/>
                <field name="student_name"/>
                <field name="program_id"/>
                <field name="club_id"/>
                <field name="parent_mobile"/>
                <field name="parent_email"/>
                <filter string="مسودة" name="draft"
                        domain="[('state', '=', 'draft')]"/>
                <filter string="مقدم" name="submitted"
                        domain="[('state', '=', 'submitted')]"/>
                <filter string="مؤكد" name="confirmed"
                        domain="[('state', '=', 'confirmed')]"/>
                <filter string="قائمة انتظار" name="waitlist"
                        domain="[('state', '=', 'waitlist')]"/>
                <separator/>
                <filter string="مدفوع" name="paid"
                        domain="[('payment_state', '=', 'paid')]"/>
                <filter string="غير مدفوع" name="not_paid"
                        domain="[('payment_state', '=', 'not_paid')]"/>
                <separator/>
                <filter string="ذكور" name="male"
                        domain="[('gender', '=', 'male')]"/>
                <filter string="إناث" name="female"
                        domain="[('gender', '=', 'female')]"/>
                <separator/>
                <filter string="اليوم" name="today"
                        domain="[('registration_date', '>=', datetime.datetime.now().replace(hour=0, minute=0, second=0)),
                                ('registration_date', '&lt;=', datetime.datetime.now().replace(hour=23, minute=59, second=59))]"/>
                <filter string="هذا الأسبوع" name="this_week"
                        domain="[('registration_date', '>=', (datetime.datetime.now() - datetime.timedelta(days=7)).strftime('%Y-%m-%d'))]"/>
                <group expand="0" string="تجميع حسب">
                    <filter string="البرنامج" name="group_program" context="{'group_by': 'program_id'}"/>
                    <filter string="النادي" name="group_club" context="{'group_by': 'club_id'}"/>
                    <filter string="الحالة" name="group_state" context="{'group_by': 'state'}"/>
                    <filter string="حالة الدفع" name="group_payment" context="{'group_by': 'payment_state'}"/>
                    <filter string="الجنس" name="group_gender" context="{'group_by': 'gender'}"/>
                    <filter string="تاريخ التسجيل" name="group_date" context="{'group_by': 'registration_date:month'}"/>
                </group>
                <searchpanel>
                    <field name="club_id" icon="fa-building"/>
                    <field name="program_id" icon="fa-graduation-cap"/>
                    <field name="state" select="multi" icon="fa-tasks"/>
                    <field name="payment_state" select="multi" icon="fa-money"/>
                </searchpanel>
            </search>
        </field>
    </record>

    <!-- Action -->
    <record id="action_program_registration" model="ir.actions.act_window">
        <field name="name">التسجيلات</field>
        <field name="res_model">program.registration</field>
        <field name="view_mode">list,kanban,form</field>
        <field name="search_view_id" ref="view_program_registration_search"/>
        <field name="context">{'search_default_confirmed': 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                لا توجد تسجيلات بعد
            </p>
            <p>
                سيظهر هنا جميع التسجيلات في البرامج المختلفة
            </p>
        </field>
    </record>

    <!-- Menu -->
    <menuitem id="menu_program_registrations"
              name="التسجيلات"
              parent="menu_charity_root"
              action="action_program_registration"
              sequence="30"/>

    <!-- Configuration Menu -->
    <menuitem id="menu_charity_config"
              name="الإعدادات"
              parent="menu_charity_root"
              sequence="100"
              groups="base.group_system"/>
</odoo>